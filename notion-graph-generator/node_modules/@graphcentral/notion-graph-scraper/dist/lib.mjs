import{NotionAPI as S}from"notion-client";var c=class{static NKG_0000(e){return`Could not find topmost block from blockId ${e}`}static NKG_0001(e){return`Root block ${e.value.id} is not an acceptable type: ${e.value.type}. Full block:
${JSON.stringify(e,null,2)}`}static NKG_0002(e){return`Failed before requesting collectionData because either collection_id or collection_view_id is not available (or both). Full block:
${JSON.stringify(e,null,2)}`}static NKG_0003(e){return`Failed to process collection_view. ${e} is not defined.`}static NKG_0004(e){return`Failed to process collection_view. collectionId: ${e} is not a key in collection.`}static NKG_0005(e){return`Block does not have value?.format?.alias_pointer?.id.
${JSON.stringify(e,null,2)}`}static NKG_0006(e,t){return`Expected maxDiscoverableNodes (${e}) to be bigger than or equal to maxDiscoverableNodesInOtherSpaces (${t}). This combination of numbers is impossible because at least one node must be from your workspace.`}};import{to as P}from"await-to-js";import{serializeError as T}from"serialize-error";async function v(r){let[e,t]=await P(r);return[T(e),t]}import A from"await-to-js";import _ from"events";var N=class{constructor({maxConcurrentRequest:e,maxRequestCount:t=1/0,lastRequestTimeoutMs:o=15e3,logger:i}){this.queue=[];this.responses=[];this.currentRequestCount=0;this.maxRequestCount=1/0;this.maxConcurrentRequest=-1;this.eventEmitter=new _;this.intervalId=null;this.hasNoMoreRequestEnqueued=!1;this.externalSuccessfulRequestCount=0;this.totalSuccessfulRequestCount=0;if(e<=0)throw new Error("maxConcurrentRequest must be bigger than 0");this.maxConcurrentRequest=e,this.lastRequestTimeoutMs=o,this.maxRequestCount=t,this.logger=i,this.checkAndSendRequest()}terminate(){this.eventEmitter.emit("complete",this.responses),this.intervalId&&clearInterval(this.intervalId)}terminateIfPossible(){this.currentRequestCount===0&&this.queue.length===0&&this.terminate()}checkAndSendRequest(){let e=[],t=0,o=()=>{var i,n,s;if(!(this.externalSuccessfulRequestCount!==0&&this.totalSuccessfulRequestCount!==0&&this.externalSuccessfulRequestCount<this.totalSuccessfulRequestCount)&&((i=this.logger)==null||i.call(this,`# current requests: ${this.currentRequestCount} / # items in the queue: ${this.queue.length}`),(n=this.logger)==null||n.call(this,`# total requests sent: ${t}`),(s=this.logger)==null||s.call(this,`# total successful requests: ${this.externalSuccessfulRequestCount}`),this.externalSuccessfulRequestCount>=this.maxRequestCount&&this.terminate(),!(this.currentRequestCount===0&&this.queue.length===0)&&this.currentRequestCount<this.maxConcurrentRequest))for(;this.currentRequestCount<this.maxConcurrentRequest;){if(this.externalSuccessfulRequestCount>=this.maxRequestCount){this.queue=[],this.currentRequestCount=0,this.hasNoMoreRequestEnqueued=!0;break}++t,e.forEach(l=>clearTimeout(l)),e=[],this.sendRequest().catch(l=>{this.responses.push(l)}).then(l=>{l&&this.responses.push(l)}).finally(()=>{++this.totalSuccessfulRequestCount,--this.currentRequestCount,this.hasNoMoreRequestEnqueued&&this.terminateIfPossible(),e.push(setTimeout(()=>{this.terminateIfPossible()},this.lastRequestTimeoutMs))}),++this.currentRequestCount}};o(),this.intervalId=setInterval(o,10)}async sendRequest(){let e=this.queue.shift();if(e===void 0)return null;let[t,o]=await A(e());return o===void 0||t!==null?t:o}setNoMoreRequestEnqueued(){this.hasNoMoreRequestEnqueued=!0}enqueue(e){this.hasNoMoreRequestEnqueued||this.queue.push(e)}onComplete(e){this.eventEmitter.on("complete",e),this.queue=[],this.responses=[]}incrementExternalRequestMatchCount(e=1){e<=0||(this.externalSuccessfulRequestCount+=e)}};function L(r){return E((()=>{var t,o,i,n,s,l,a,f;if(r.object==="database")return(t=r.title)==null?void 0:t[0].plain_text;if(r.object==="page")return((n=(i=(o=r.properties)==null?void 0:o.Name)==null?void 0:i.title)==null?void 0:n[0].plain_text)??((a=(l=(s=r.properties)==null?void 0:s.title)==null?void 0:l.title)==null?void 0:a[0].plain_text);if(r.object==="block")return((f=r.child_page)==null?void 0:f.title)??r.child_database.title;throw new Error("should never get here")})())}function k(r){if(M(r))return r;if(r.length!=32)throw new Error(`Incorrect length of id: ${r.length}`);if(!/^[a-zA-Z0-9]{32}$/.test(r))throw new Error(`Incorrect format of id: ${r}. It must be /^[a-zA-Z0-9]{32}$/`);return`${r.substring(0,8)}-${r.substring(8,12)}-${r.substring(12,16)}-${r.substring(16,20)}-${r.substring(20,32)}`}function M(r){return r.length!==36?!1:/^[a-zA-Z0-9]{8}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{12}$/.test(r)}function E(r){return r===""?"Untitled":r}var b=class{constructor(){this.graph={};this.nodesLength=0}addEdgeByIds(e,t){let o=this.graph[e],i=this.graph[t];i&&i[e]||(o||(o={}),o[t]=!0,this.graph[e]=o,this.nodesLength+=1)}addEdge(e,t){this.addEdgeByIds(e.id,t.id)}getGraph(){return this.graph}getD3JsEdgeFormat(){let e=[];return Object.keys(this.graph).map(t=>{let o=this.graph[t];if(!!o)for(let i of Object.keys(o))e.push({source:t,target:i})}),e}get length(){return this.length}};function R(r){return r==="page"||r==="collection_view"||r==="collection_view_page"||r==="alias"}var u=class{static getTitleFromPageBlock(e){var i,n;let{properties:t}=e.value;if(!t)return"Untitled";let o=(n=(i=t==null?void 0:t.title)==null?void 0:i[0])==null?void 0:n[0];return o==null?"Untitled":E(o)}static getTitleFromCollectionBlock(e){var o,i,n;let t=(n=(i=(o=e.value)==null?void 0:o.name)==null?void 0:i[0])==null?void 0:n[0];return t??"Unknown database title"}static isBlockToplevelPageOrCollectionViewPage(e){var t;return((t=e.value)==null?void 0:t.parent_table)==="space"}static extractTypeUnsafeNotionContentNodeFromBlock(e){let t=u.getTitleFromPageBlock(e),o=e.value.type,i=e.value.space_id??"Unknown space id";return R(o)?o==="collection_view_page"?e.value.collection_id?{id:e.value.id,title:t,type:o,spaceId:i,parentId:"none",collection_id:e.value.collection_id}:null:{id:e.value.id,title:t,type:o,spaceId:i,parentId:"none"}:null}};function x(r){return r?e=>{let t=new Date;console.log(`[${t.toLocaleString()}] ${e}`)}:null}var w=class{constructor({unofficialNotionAPI:e=new S,maxDiscoverableNodes:t=500,maxDiscoverableNodesInOtherSpaces:o=250,maxConcurrentRequest:i=35,lastRequestTimeoutMs:n=15e3,verbose:s=!0}){this.errors=[];this.nodes={};this.nodesLength=0;this.otherSpacesNodesLength=0;this.nodesGraph=new b;this.verbose=!0;if(t!==null&&t<o)throw new Error(c.NKG_0006(t,o));this.unofficialNotionAPI=e,this.maxDiscoverableNodes=t??1/0,this.maxConcurrentRequest=i,this.maxDiscoverableNodesInOtherSpaces=o,this.lastRequestTimeoutMs=n,this.verbose=s,this.logger=x(s)}accumulateError(e){this.errors.push(e)}async findTopmostBlock(e){let[t,o]=await v(this.unofficialNotionAPI.getPage(e));if(t||!o)return t&&(this.errors.push(t),this.errors.push(new Error(c.NKG_0000(e)))),null;let i=Object.values(o.block).find(n=>n.value.id===k(e)||u.isBlockToplevelPageOrCollectionViewPage(n));return i||(this.errors.push(new Error(c.NKG_0000(e))),null)}addDiscoveredNode({childNode:e,parentNode:t,requestQueue:o,rootBlockSpaceId:i}){e.id in this.nodes||(this.nodesLength+=1),this.nodes[e.id]=e,this.nodesGraph.addEdge(e,t),t.cc?t.cc+=1:t.cc=1,o.incrementExternalRequestMatchCount(),o.enqueue(()=>this.recursivelyDiscoverBlocks({rootBlockSpaceId:i,requestQueue:o,parentNode:e}))}addCollectionViewTitleInNextRecursiveCall(e,t){if(t.type!=="collection_view"&&t.type!=="collection_view_page")return;let o=e.block,i=e.collection,n=o[t.id],s=n.value.collection_id;if(i||this.accumulateError(new Error(c.NKG_0003("collection"))),s||this.accumulateError(new Error(c.NKG_0003("collectionId"))),n||this.accumulateError(new Error(c.NKG_0003("collectionViewBlock"))),s&&i&&!(s in i)&&this.accumulateError(new Error(c.NKG_0004(s))),i&&s&&n&&s in i){let l=i[s],a=u.getTitleFromCollectionBlock(l);t.id in this.nodes&&(this.nodes[t.id].title=a)}}async recursivelyDiscoverBlocks({rootBlockSpaceId:e,parentNode:t,requestQueue:o}){var s,l,a,f,I,y;let[i,n]=await v(this.unofficialNotionAPI.getPage(t.id));if(i&&this.accumulateError(i),!!n){(t.type==="collection_view"||t.type==="collection_view_page")&&this.addCollectionViewTitleInNextRecursiveCall(n,t);for(let h of Object.keys(n.block)){if(this.maxDiscoverableNodes&&this.nodesLength>this.maxDiscoverableNodes){o.setNoMoreRequestEnqueued();return}let d=n.block[h];if(!d||!d.value)continue;let g=n.block[h].value.type,m=n.block[h].value.space_id;if(!R(g)||h===k(t.id)||h in this.nodes||!m)continue;if(g!=="alias"&&m!==e){if(this.otherSpacesNodesLength>this.maxDiscoverableNodesInOtherSpaces)continue;this.otherSpacesNodesLength+=1}let q=h;switch(g){case"alias":{let p=(a=(l=(s=d.value)==null?void 0:s.format)==null?void 0:l.alias_pointer)==null?void 0:a.id,C=(y=(I=(f=d.value)==null?void 0:f.format)==null?void 0:I.alias_pointer)==null?void 0:y.spaceId;p?this.nodesGraph.addEdgeByIds(t.id,p):this.errors.push(new Error(c.NKG_0005(d)));break}case"collection_view":{let p={title:"Unknown database title",id:q,spaceId:m,parentId:t.id,type:g};this.addDiscoveredNode({childNode:p,parentNode:t,requestQueue:o,rootBlockSpaceId:e});break}case"collection_view_page":{let p={title:"Unknown database page title",id:q,collection_id:d.value.collection_id,parentId:t.id,spaceId:m,type:g};this.addDiscoveredNode({childNode:p,parentNode:t,requestQueue:o,rootBlockSpaceId:e});break}case"page":{let p=u.getTitleFromPageBlock(d),C=d.value.space_id??"Unknown space id",B={id:q,parentId:t.id,spaceId:C,type:g,title:p};this.addDiscoveredNode({childNode:B,parentNode:t,requestQueue:o,rootBlockSpaceId:e});break}}}}}async buildGraphFromRootNode(e){let t={links:[],nodes:Object.values(this.nodes),errors:this.errors},o=new N({maxRequestCount:this.maxDiscoverableNodes,maxConcurrentRequest:this.maxConcurrentRequest,lastRequestTimeoutMs:this.lastRequestTimeoutMs,logger:this.logger}),i=await this.findTopmostBlock(e);if(!i)return t;let n=u.extractTypeUnsafeNotionContentNodeFromBlock(i),s=i.value.space_id;if(!n)return this.errors.push(new Error(c.NKG_0001(i))),t;this.nodes[n.id]=n,await v(Promise.allSettled([this.recursivelyDiscoverBlocks({parentNode:n,rootBlockSpaceId:s,requestQueue:o}),new Promise(a=>o.onComplete(a))]));let l=this.nodesGraph.getD3JsEdgeFormat().filter(({source:a,target:f})=>a in this.nodes&&f in this.nodes);return{nodes:Object.values(this.nodes),links:l,errors:this.errors}}};export{w as NotionGraph,N as RequestQueue,b as UndirectedNodesGraph,u as UnofficialNotionAPIUtil,L as identifyObjectTitle,M as isIdAlreadySeparateByDash,E as nameUntitledIfEmpty,k as separateIdWithDashSafe};
